<div class="header">
  <img src="assets/logo.png" alt="Richbond Logo" class="logo" />
  <div class="header-icons">
    <mat-icon style="color: #0e6af4 !important">notifications_none</mat-icon>

    <!-- Bouton de changement de langue -->
    <button mat-button [matMenuTriggerFor]="languageMenu" class="lang-button">
      <img
        [src]="'assets/' + (currentLanguage === 'fr' ? 'OIP.webp' : 'usa.png')"
        alt="Language"
        class="lang-icon"
      />
      <span>{{ currentLanguage | uppercase }}</span>
      <mat-icon>arrow_drop_down</mat-icon>
    </button>

    <mat-menu #languageMenu="matMenu">
      <button mat-menu-item (click)="changeLanguage('fr')">
        <img src="assets/OIP.webp" alt="Français" class="lang-option-icon" />
        <span>FR</span>
      </button>
      <button mat-menu-item (click)="changeLanguage('en')">
        <img src="assets/usa.png" alt="English" class="lang-option-icon" />
        <span>EN</span>
      </button>
    </mat-menu>

    <mat-icon style="color: #0e6af4 !important">settings</mat-icon>
  </div>
</div>
<div class="container">
  <div class="example-container">
    <!-- ✅ SIDEBAR NAVIGATION -->
    <div class="sidebar" [class.sidebar-collapsed]="!menuOpen">
      <div class="user-profile" [class.user-profile-collapsed]="!menuOpen">
        <!-- Image dynamique : avatarUrl ou imagePath -->
        <img
          [src]="avatarUrl"
          alt="Avatar"
          width="100"
          height="100"
          style="border-radius: 50%"
        />
        <div class="user-info" [class.user-info-hidden]="!menuOpen">
          <strong>{{ username }}</strong>
          <p>{{ role }}</p>

          <!-- Logo de l'entreprise dans la section utilisateur -->
        </div>
      </div>

      <mat-nav-list [class.nav-list-collapsed]="!menuOpen">
        <a
          mat-list-item
          routerLink="/Dashbord"
          routerLinkActive="active-link"
          [class.nav-item-collapsed]="!menuOpen"
          [matTooltip]="!menuOpen ? ('COMMON.DASHBOARD' | translate) : ''"
          matTooltipPosition="right"
        >
          <mat-icon matListItemIcon>dashboard</mat-icon>
          <span matListItemTitle [class.text-hidden]="!menuOpen">{{
            "COMMON.DASHBOARD" | translate
          }}</span>
        </a>

        <!-- <a mat-list-item (click)="userMenuOpen = !userMenuOpen" [class.nav-item-collapsed]="!menuOpen"
           [matTooltip]="!menuOpen ? ('COMMON.USERS' | translate) : ''" matTooltipPosition="right">
          <mat-icon matListItemIcon>people</mat-icon>
          <span matListItemTitle [class.text-hidden]="!menuOpen">{{ 'COMMON.USERS' | translate }}</span>
          <mat-icon style="margin-left:auto;" [class.text-hidden]="!menuOpen">{{ userMenuOpen ? 'expand_less' : 'expand_more' }}</mat-icon>
        </a> -->
        <a
          mat-list-item
          routerLink="/login-history"
          routerLinkActive="active-link"
          [class.nav-item-collapsed]="!menuOpen"
          [matTooltip]="!menuOpen ? ('LOGIN_HISTORY.TITLE' | translate) : ''"
          matTooltipPosition="right"
        >
          <mat-icon matListItemIcon>history</mat-icon>
          <span matListItemTitle [class.text-hidden]="!menuOpen">{{
            "LOGIN_HISTORY.TITLE" | translate
          }}</span>
        </a>

        <a
          mat-list-item
          routerLink="/users"
          routerLinkActive="active-link"
          [class.nav-item-collapsed]="!menuOpen"
          [matTooltip]="!menuOpen ? ('DASHBOARD.ALL_USERS' | translate) : ''"
          matTooltipPosition="right"
        >
          <mat-icon matListItemIcon>group</mat-icon>
          <span matListItemTitle [class.text-hidden]="!menuOpen">{{
            "DASHBOARD.ALL_USERS" | translate
          }}</span>
        </a>

        <a
          mat-list-item
          routerLink="/merchendiseur"
          routerLinkActive="active-link"
          [class.nav-item-collapsed]="!menuOpen"
          [matTooltip]="!menuOpen ? ('COMMON.MERCHANDISERS' | translate) : ''"
          matTooltipPosition="right"
        >
          <mat-icon matListItemIcon>storefront</mat-icon>
          <span matListItemTitle [class.text-hidden]="!menuOpen">{{
            "COMMON.MERCHANDISERS" | translate
          }}</span>
        </a>

        <a
          mat-list-item
          routerLink="/superviseur"
          routerLinkActive="active-link"
          [class.nav-item-collapsed]="!menuOpen"
          [matTooltip]="!menuOpen ? ('COMMON.SUPERVISORS' | translate) : ''"
          matTooltipPosition="right"
        >
          <mat-icon matListItemIcon>supervisor_account</mat-icon>
          <span matListItemTitle [class.text-hidden]="!menuOpen">{{
            "COMMON.SUPERVISORS" | translate
          }}</span>
        </a>

        <a
          mat-list-item
          routerLink="/magasins"
          routerLinkActive="active-link"
          [class.nav-item-collapsed]="!menuOpen"
          [matTooltip]="!menuOpen ? ('COMMON.STORES' | translate) : ''"
          matTooltipPosition="right"
        >
          <mat-icon matListItemIcon>store</mat-icon>
          <span matListItemTitle [class.text-hidden]="!menuOpen">{{
            "COMMON.STORES" | translate
          }}</span>
        </a>

        <a
          mat-list-item
          routerLink="/planification"
          routerLinkActive="active-link"
          [class.nav-item-collapsed]="!menuOpen"
          [matTooltip]="!menuOpen ? ('COMMON.PLANNING' | translate) : ''"
          matTooltipPosition="right"
        >
          <mat-icon matListItemIcon>event_note</mat-icon>
          <span matListItemTitle [class.text-hidden]="!menuOpen">{{
            "COMMON.PLANNING" | translate
          }}</span>
        </a>

        <a
          mat-list-item
          routerLink="/kpi"
          routerLinkActive="active-link"
          [class.nav-item-collapsed]="!menuOpen"
          [matTooltip]="!menuOpen ? 'Indicateurs de Performance' : ''"
          matTooltipPosition="right"
        >
          <mat-icon matListItemIcon>analytics</mat-icon>
          <span matListItemTitle [class.text-hidden]="!menuOpen">KPI</span>
        </a>

        <a
          mat-list-item
          routerLink="/gestion-visites"
          routerLinkActive="active-link"
          [class.nav-item-collapsed]="!menuOpen"
          [matTooltip]="!menuOpen ? ('COMMON.VISIT' | translate) : ''"
          matTooltipPosition="right"
        >
          <mat-icon matListItemIcon>location_on</mat-icon>
          <span matListItemTitle [class.text-hidden]="!menuOpen">{{
            "COMMON.VISIT" | translate
          }}</span>
        </a>

        <a
          mat-list-item
          routerLink="/Produit"
          routerLinkActive="active-link"
          [class.nav-item-collapsed]="!menuOpen"
          [matTooltip]="!menuOpen ? ('COMMON.PRODUCTS' | translate) : ''"
          matTooltipPosition="right"
        >
          <mat-icon matListItemIcon>inventory</mat-icon>
          <span matListItemTitle [class.text-hidden]="!menuOpen">{{
            "COMMON.PRODUCTS" | translate
          }}</span>
        </a>

        <a
          mat-list-item
          routerLink="/gestion-stock"
          routerLinkActive="active-link"
          [class.nav-item-collapsed]="!menuOpen"
          [matTooltip]="!menuOpen ? 'Gestion de Stock' : ''"
          matTooltipPosition="right"
        >
          <mat-icon matListItemIcon>warehouse</mat-icon>
          <span matListItemTitle [class.text-hidden]="!menuOpen"
            >Gestion de Stock</span
          >
        </a>

        <a
          mat-list-item
          routerLink="/parametre"
          routerLinkActive="active-link"
          [class.nav-item-collapsed]="!menuOpen"
          [matTooltip]="!menuOpen ? ('COMMON.SETTINGS' | translate) : ''"
          matTooltipPosition="right"
        >
          <mat-icon matListItemIcon>settings</mat-icon>
          <span matListItemTitle [class.text-hidden]="!menuOpen">{{
            "COMMON.SETTINGS" | translate
          }}</span>
        </a>

        <a
          mat-list-item
          routerLink="/help"
          routerLinkActive="active-link"
          [class.nav-item-collapsed]="!menuOpen"
          [matTooltip]="!menuOpen ? ('COMMON.HELP' | translate) : ''"
          matTooltipPosition="right"
        >
          <mat-icon matListItemIcon>help_outline</mat-icon>
          <span matListItemTitle [class.text-hidden]="!menuOpen">{{
            "COMMON.HELP" | translate
          }}</span>
        </a>
        <a
          mat-list-item
          (click)="openLogoutDialog()"
          [class.nav-item-collapsed]="!menuOpen"
          [matTooltip]="!menuOpen ? ('AUTH.LOGOUT' | translate) : ''"
          matTooltipPosition="right"
        >
          <mat-icon matListItemIcon style="color: #ff0022">logout</mat-icon>
          <span
            matListItemTitle
            style="color: #ff0022"
            [class.text-hidden]="!menuOpen"
            >{{ "AUTH.LOGOUT" | translate }}</span
          >
        </a>
      </mat-nav-list>
    </div>

    <div class="content">
      <div class="page-header">
        <div class="page-header-left">
          <button mat-icon-button (click)="toggleMenu()" class="menu-toggle">
            <mat-icon *ngIf="!menuOpen" style="color: #333; margin-bottom: 15px"
              >keyboard_arrow_left</mat-icon
            >
            <mat-icon *ngIf="menuOpen" style="color: #333; margin-bottom: 15px"
              >keyboard_arrow_right</mat-icon
            >
          </button>
          <h1>{{ "COMMON.DASHBOARD" | translate }}</h1>
        </div>
      </div>

      <div class="filters-container">
        <div
          class="filters flex items-center p-3 bg-white rounded-lg shadow-sm"
        >
          <mat-form-field appearance="outline" class="filter-field">
            <mat-label>{{ "PLANNING.FILTERS.MONTH" | translate }}</mat-label>
            <mat-select
              [(value)]="selectedMonth"
              (selectionChange)="filterPlanificationsByMonth()"
            >
              <!-- <mat-option [value]="0">{{ 'PLANNING.FILTERS.ALL_MONTHS' | translate }}</mat-option> -->
              <mat-option
                *ngFor="let month of months; let i = index"
                [value]="i"
              >
                {{ month | translate }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <span class="separator"></span>

          <mat-form-field appearance="outline" class="filter-field">
            <mat-label>{{ "PLANNING.FILTERS.STORE" | translate }}</mat-label>
            <mat-select
              panelClass="filter-select"
              [(value)]="selectedMagasin"
              (selectionChange)="filterByMagasin()"
            >
              <mat-option [value]="null">{{
                "PLANNING.FILTERS.ALL_STORES" | translate
              }}</mat-option>
              <mat-option
                *ngFor="let magasin of allMagasins"
                [value]="magasin.id"
              >
                {{ magasin.nom }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <span class="separator"></span>

          <mat-form-field appearance="outline" class="filter-field">
            <mat-label>{{
              "PLANNING.FILTERS.MERCHANDISER" | translate
            }}</mat-label>
            <mat-select
              panelClass="filter-select"
              [(value)]="selectedMerchandiseur"
              (selectionChange)="filterMerchandiseurs()"
            >
              <mat-option [value]="null">{{
                "PLANNING.FILTERS.ALL_MERCHANDISERS" | translate
              }}</mat-option>
              <mat-option
                *ngFor="let merch of marchandiseurs"
                [value]="merch.id"
              >
                {{ merch.nom }} {{ merch.prenom }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <button mat-icon-button class="custom-icon-button">
            <mat-icon>more_vert</mat-icon>
          </button>
        </div>
      </div>

      <div class="stats-grid">
        <mat-card class="stat-card">
          <div class="text-content">
            <mat-icon class="stat-icon">check_circle</mat-icon>
            <span class="stat-label">{{
              "DASHBOARD.TASKS_PLANNED" | translate
            }}</span>
            <h2>{{ totalPlanifiees }}</h2>
          </div>
        </mat-card>

        <mat-card class="stat-card">
          <div class="text-content">
            <mat-icon class="stat-icon">check_circle</mat-icon>
            <span class="stat-label">{{
              "DASHBOARD.TASKS_DONE" | translate
            }}</span>
            <h2>{{ totalEffectuees }}</h2>
          </div>
        </mat-card>

        <mat-card class="stat-card">
          <div class="text-content">
            <mat-icon class="stat-icon">check_circle</mat-icon>
            <span class="stat-label">{{
              "DASHBOARD.TASKS_LEFT" | translate
            }}</span>
            <h2>{{ totalRestantes }}</h2>
          </div>
        </mat-card>
      </div>

      <!-- Section des graphiques -->
      <div class="charts-container">
        <div class="charts-grid">
          <mat-card class="chart-card" (click)="goToPlabification()">
            <mat-card-content>
              <div class="calendar-header">
                <h1 class="card-title">{{ "PLANNING.TITLE" | translate }}</h1>
                <div class="calendar-filters">
                  <mat-form-field
                    appearance="outline"
                    class="filter-select"
                    (click)="$event.stopPropagation()"
                  >
                    <mat-select
                      [(ngModel)]="selectedMonth"
                      (selectionChange)="onMonthChange()"
                    >
                      <mat-option
                        *ngFor="let month of months; let i = index"
                        [value]="i"
                      >
                        {{ month | translate }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>

                  <mat-form-field
                    appearance="outline"
                    class="filter-select"
                    (click)="$event.stopPropagation()"
                  >
                    <mat-select
                      [(ngModel)]="selectedYear"
                      (selectionChange)="onYearChange()"
                    >
                      <mat-option *ngFor="let year of years" [value]="year">{{
                        year
                      }}</mat-option>
                    </mat-select>
                  </mat-form-field>
                </div>
              </div>

              <nz-calendar
                [nzFullscreen]="false"
                [nzDateFullCell]="dateCell"
                [(nzValue)]="calendarDate"
                (nzPanelChange)="onCalendarMonthChange($event)"
                (nzSelectChange)="onValueChange($event)"
                [nzCustomHeader]="customHeader"
                [nzFullscreen]="false"
                (click)="$event.stopPropagation()"
              ></nz-calendar>

              <ng-template #customHeader let-date></ng-template>
              <ng-template #dateCell let-date>
                <div class="day-cell" [ngClass]="getDayCellClass(date)">
                  <span
                    class="day-number"
                    [class.has-events]="hasPlanif(date)"
                    >{{ date.getDate() }}</span
                  >
                </div>
              </ng-template>
            </mat-card-content>

            <div class="legend">
              <div class="status-legend">
                <span class="circle event-planned"></span>
                {{ "PLANNING.LEGEND.PLANNED" | translate }}
              </div>
              <div class="status-legend">
                <span class="circle event-in-progress"></span>
                {{ "PLANNING.LEGEND.IN_PROGRESS" | translate }}
              </div>
              <div class="status-legend">
                <span class="circle event-done"></span>
                {{ "PLANNING.LEGEND.DONE" | translate }}
              </div>
              <div class="status-legend">
                <span class="circle event-rescheduled"></span>
                {{ "PLANNING.LEGEND.RESCHEDULED" | translate }}
              </div>
              <div class="status-legend">
                <span class="circle event-not-done"></span>
                {{ "PLANNING.LEGEND.NOT_DONE" | translate }}
              </div>
            </div>
          </mat-card>

          <!-- Graphique des planifications par statut -->
          <mat-card class="chart-card">
            <mat-card-header>
              <mat-card-title>
                <mat-icon>event_note</mat-icon>
                {{ "DASHBOARD.PLANNING_BY_STATUS" | translate }}
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="chart-container">
                <canvas id="planificationsChart"></canvas>
              </div>
            </mat-card-content>
          </mat-card>
        </div>

        <!-- Section des KPIs côte à côte -->
        <div class="charts-grid">
          <!-- Graphique d'intégration des utilisateurs -->
          <mat-card class="chart-card">
            <mat-card-header>
              <mat-card-title>
                <mat-icon>trending_up</mat-icon>
                Intégration des Utilisateurs par Mois
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="chart-container">
                <canvas id="usersIntegrationChart"></canvas>
              </div>
            </mat-card-content>
          </mat-card>

          <!-- KPI 2: Utilisation de l'App -->
          <mat-card class="kpi-card">
            <mat-card-header>
              <mat-card-title>{{ "KPI.APP_USAGE" | translate }}</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="chart-container">
                <canvas id="kpiUsageChart"></canvas>
              </div>
              <div class="kpi-stats" *ngIf="kpiAppUsageData">
                <div class="stat-item">
                  <div class="stat-value">
                    {{ kpiAppUsageData.activeUsers }}/{{
                      kpiAppUsageData.totalUsers
                    }}
                  </div>
                  <div class="stat-label">Utilisateurs Actifs</div>
                </div>
                <div class="stat-item">
                  <div class="stat-value">
                    {{ kpiAppUsageData.dailyActiveUsers }}
                  </div>
                  <div class="stat-label">Actifs Aujourd'hui</div>
                </div>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
        <!-- Section KPI -->
        <div class="kpi-section">
          <div class="kpi-header">
            <h2 class="section-title">
              <mat-icon>analytics</mat-icon>
              {{ "KPI.TITLE" | translate }}
              <span
                class="data-mode-indicator"
                [class.mock-mode]="kpiDataMode === 'mock'"
              >
                <mat-icon *ngIf="kpiDataMode === 'mock'">warning</mat-icon>
                <span *ngIf="kpiDataMode === 'mock'">Mode Démo</span>
                <mat-icon *ngIf="kpiDataMode === 'real'">check_circle</mat-icon>
                <span *ngIf="kpiDataMode === 'real'">Données Réelles</span>
              </span>
            </h2>

            <!-- Filtres KPI -->
            <div class="kpi-filters">
              <mat-form-field appearance="outline" class="filter-field">
                <mat-label>Date de début</mat-label>
                <input
                  matInput
                  type="date"
                  [(ngModel)]="kpiFilters.dateRange.startDate"
                  (change)="applyKpiFilters()"
                />
              </mat-form-field>

              <mat-form-field appearance="outline" class="filter-field">
                <mat-label>Date de fin</mat-label>
                <input
                  matInput
                  type="date"
                  [(ngModel)]="kpiFilters.dateRange.endDate"
                  (change)="applyKpiFilters()"
                />
              </mat-form-field>

              <mat-form-field appearance="outline" class="filter-field">
                <mat-label>Région</mat-label>
                <mat-select
                  [(value)]="kpiFilters.region"
                  (selectionChange)="applyKpiFilters()"
                >
                  <mat-option value="">Toutes les régions</mat-option>
                  <mat-option value="Casablanca-Settat"
                    >Casablanca-Settat</mat-option
                  >
                  <mat-option value="Rabat-Salé-Kénitra"
                    >Rabat-Salé-Kénitra</mat-option
                  >
                  <mat-option value="Marrakech-Safi">Marrakech-Safi</mat-option>
                  <mat-option value="Fès-Meknès">Fès-Meknès</mat-option>
                  <mat-option value="Tanger-Tétouan-Al Hoceïma"
                    >Tanger-Tétouan-Al Hoceïma</mat-option
                  >
                </mat-select>
              </mat-form-field>

              <button
                mat-raised-button
                color="primary"
                (click)="applyKpiFilters()"
                class="filter-button"
              >
                <mat-icon>filter_list</mat-icon>
                Filtrer
              </button>

              <button
                mat-raised-button
                color="accent"
                (click)="clearKpiFilters()"
                class="filter-button"
              >
                <mat-icon>clear</mat-icon>
                Effacer
              </button>

              <button
                mat-raised-button
                color="warn"
                (click)="refreshKpiData()"
                class="filter-button"
              >
                <mat-icon>refresh</mat-icon>
                Actualiser
              </button>
            </div>
          </div>

          <div class="kpi-grid">
            <!-- KPI 1: Suivi des Affectations -->
            <mat-card class="kpi-card">
              <mat-card-header>
                <mat-card-title>{{
                  "KPI.ASSIGNMENT_TRACKING" | translate
                }}</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <div class="chart-container">
                  <canvas id="kpiAssignmentChart"></canvas>
                </div>
                <div class="kpi-stats">
                  <div class="stat-item">
                    <div class="stat-value">{{ getTotalAssignments() }}</div>
                    <div class="stat-label">Total Planifications</div>
                  </div>
                  <div class="stat-item">
                    <div class="stat-value">
                      {{ getCompletedAssignments() }}
                    </div>
                    <div class="stat-label">Terminées</div>
                  </div>
                  <div class="stat-item">
                    <div class="stat-value">{{ getPendingAssignments() }}</div>
                    <div class="stat-label">En Attente</div>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>

            <!-- KPI 3: Finalisation des Rapports -->
            <mat-card class="kpi-card">
              <mat-card-header>
                <mat-card-title>{{
                  "KPI.REPORT_COMPLETION" | translate
                }}</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <div class="chart-container">
                  <canvas id="kpiReportChart"></canvas>
                </div>
                <div class="kpi-stats" *ngIf="kpiReportData.length > 0">
                  <div class="stat-item">
                    <div class="stat-value">
                      {{ getAverageCompletionRate() }}%
                    </div>
                    <div class="stat-label">Taux Moyen</div>
                  </div>
                  <div class="stat-item">
                    <div class="stat-value">
                      {{ getTotalCompletedReports() }}
                    </div>
                    <div class="stat-label">Rapports Complétés</div>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>
          </div>
          <div class="kpi-container">
            <!-- Header avec filtres -->
            <div class="kpi-header">
              <div class="header-content">
                <h1 class="page-title">
                  <mat-icon>analytics</mat-icon>
                  {{ "KPI.TITLE" | translate }}
                </h1>

                <div class="filters-section">
                  <mat-form-field appearance="outline" class="filter-field">
                    <mat-label>Région</mat-label>
                    <mat-select
                      [(value)]="selectedKpiRegion"
                      (selectionChange)="onKpiRegionChange()"
                    >
                      <mat-option
                        *ngFor="let region of kpiRegions"
                        [value]="region"
                      >
                        {{ region }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="filter-field">
                    <mat-label>Période</mat-label>
                    <mat-select
                      [(value)]="selectedKpiPeriod"
                      (selectionChange)="onKpiPeriodChange()"
                    >
                      <mat-option value="week">Cette semaine</mat-option>
                      <mat-option value="month">Ce mois</mat-option>
                      <mat-option value="quarter">Ce trimestre</mat-option>
                      <mat-option value="year">Cette année</mat-option>
                    </mat-select>
                  </mat-form-field>

                  <div class="export-buttons">
                    <button
                      mat-raised-button
                      color="primary"
                      (click)="exportKpiToExcel()"
                    >
                      <mat-icon>download</mat-icon>
                      Excel
                    </button>
                    <button
                      mat-raised-button
                      color="accent"
                      (click)="exportKpiToPDF()"
                    >
                      <mat-icon>picture_as_pdf</mat-icon>
                      PDF
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Loading indicator -->
            <div *ngIf="kpiLoading" class="loading-container">
              <mat-progress-bar mode="indeterminate"></mat-progress-bar>
              <p>Chargement des indicateurs...</p>
            </div>

            <!-- Contenu principal -->
            <div *ngIf="!kpiLoading" class="kpi-content">
              <!-- Résumé des statistiques globales -->
              <div class="stats-summary" *ngIf="kpiAppUsageData">
                <mat-card class="summary-card">
                  <mat-card-content>
                    <div class="stat-item">
                      <div class="stat-value">
                        {{ kpiAppUsageData.totalUsers }}
                      </div>
                      <div class="stat-label">Utilisateurs Total</div>
                    </div>
                    <div class="stat-item">
                      <div class="stat-value">
                        {{ kpiAppUsageData.activeUsers }}
                      </div>
                      <div class="stat-label">Utilisateurs Actifs</div>
                    </div>
                    <div class="stat-item">
                      <div class="stat-value">
                        {{ kpiAppUsageData.dailyActiveUsers }}
                      </div>
                      <div class="stat-label">Actifs Aujourd'hui</div>
                    </div>
                    <div class="stat-item">
                      <div class="stat-value">
                        {{ kpiAppUsageData.averageSessionDuration }}
                      </div>
                      <div class="stat-label">Durée Moyenne Session</div>
                    </div>
                  </mat-card-content>
                </mat-card>
              </div>

              <!-- Onglets pour les différents KPIs -->
              <mat-tab-group class="kpi-tabs">
                <!-- Onglet 1: Suivi des Affectations -->
                <mat-tab [label]="'KPI.ASSIGNMENT_TRACKING' | translate">
                  <div class="tab-content">
                    <!-- Graphique des affectations -->
                    <div class="chart-container">
                      <mat-card>
                        <mat-card-header>
                          <mat-card-title
                            >Suivi des Affectations par
                            Merchandiser</mat-card-title
                          >
                        </mat-card-header>
                        <mat-card-content>
                          <div class="chart-wrapper">
                            <canvas id="kpiAssignmentChart"></canvas>
                          </div>
                        </mat-card-content>
                      </mat-card>
                    </div>

                    <!-- Table des affectations -->
                    <div class="table-container">
                      <mat-card>
                        <mat-card-header>
                          <mat-card-title
                            >Détail des Affectations</mat-card-title
                          >
                        </mat-card-header>
                        <mat-card-content>
                          <div class="table-wrapper">
                            <table
                              mat-table
                              [dataSource]="assignmentDataSource"
                              class="kpi-table"
                            >
                              <!-- Colonne Merchandiser -->
                              <ng-container matColumnDef="merchandiserName">
                                <th mat-header-cell *matHeaderCellDef>
                                  Merchandiser
                                </th>
                                <td mat-cell *matCellDef="let element">
                                  <div class="merchandiser-info">
                                    <strong>{{
                                      element.merchandiserName
                                    }}</strong>
                                    <span class="merchandiser-id"
                                      >#{{ element.merchandiserId }}</span
                                    >
                                  </div>
                                </td>
                              </ng-container>

                              <!-- Colonne Région -->
                              <ng-container matColumnDef="region">
                                <th mat-header-cell *matHeaderCellDef>
                                  Région
                                </th>
                                <td mat-cell *matCellDef="let element">
                                  <mat-chip-set>
                                    <mat-chip>{{ element.region }}</mat-chip>
                                  </mat-chip-set>
                                </td>
                              </ng-container>

                              <!-- Colonne Assignations Total -->
                              <ng-container matColumnDef="totalAssignments">
                                <th mat-header-cell *matHeaderCellDef>
                                  Total Assignations
                                </th>
                                <td mat-cell *matCellDef="let element">
                                  <div class="assignment-stats">
                                    <div class="total-assignments">
                                      {{ element.totalAssignments }}
                                    </div>
                                    <div class="assignment-breakdown">
                                      <span class="completed"
                                        >{{
                                          element.completedAssignments
                                        }}
                                        complétées</span
                                      >
                                      <span class="pending"
                                        >{{ element.pendingAssignments }} en
                                        attente</span
                                      >
                                      <span class="in-progress"
                                        >{{ element.inProgressAssignments }} en
                                        cours</span
                                      >
                                    </div>
                                  </div>
                                </td>
                              </ng-container>

                              <!-- Colonne Taux de Completion -->
                              <ng-container matColumnDef="completionRate">
                                <th mat-header-cell *matHeaderCellDef>
                                  Taux de Completion
                                </th>
                                <td mat-cell *matCellDef="let element">
                                  <div class="completion-info">
                                    <div class="completion-rate">
                                      {{ element.completionRate }}%
                                    </div>
                                    <mat-progress-bar
                                      mode="determinate"
                                      [value]="element.completionRate"
                                      [color]="
                                        getCompletionRate(
                                          element.completionRate
                                        )
                                      "
                                    >
                                    </mat-progress-bar>
                                  </div>
                                </td>
                              </ng-container>

                              <!-- Colonne Statut -->
                              <ng-container matColumnDef="status">
                                <th mat-header-cell *matHeaderCellDef>
                                  Statut
                                </th>
                                <td mat-cell *matCellDef="let element">
                                  <mat-chip-set>
                                    <mat-chip
                                      [style.background-color]="
                                        getCompletionColor(
                                          element.completionRate
                                        )
                                      "
                                    >
                                      {{ getAssignmentStatus(element) }}
                                    </mat-chip>
                                  </mat-chip-set>
                                </td>
                              </ng-container>

                              <!-- Colonne Dernière Activité -->
                              <ng-container matColumnDef="lastActivity">
                                <th mat-header-cell *matHeaderCellDef>
                                  Dernière Activité
                                </th>
                                <td mat-cell *matCellDef="let element">
                                  <div class="last-activity">
                                    <mat-icon>schedule</mat-icon>
                                    {{
                                      element.lastActivityDate
                                        | date : "dd/MM/yyyy"
                                    }}
                                    <div class="avg-time">
                                      Moy: {{ element.averageCompletionTime }}
                                    </div>
                                  </div>
                                </td>
                              </ng-container>

                              <tr
                                mat-header-row
                                *matHeaderRowDef="assignmentColumns"
                              ></tr>
                              <tr
                                mat-row
                                *matRowDef="let row; columns: assignmentColumns"
                              ></tr>
                            </table>

                            <mat-paginator
                              #assignmentPaginator
                              [pageSizeOptions]="[5, 10, 20]"
                              [pageSize]="10"
                              showFirstLastButtons
                            >
                            </mat-paginator>
                          </div>
                        </mat-card-content>
                      </mat-card>
                    </div>
                  </div>
                </mat-tab>

                <!-- Onglet 2: Utilisation de l'Application -->
                <mat-tab [label]="'KPI.APP_USAGE' | translate">
                  <div class="tab-content">
                    <!-- Graphique d'utilisation -->
                    <div class="chart-container">
                      <mat-card>
                        <mat-card-header>
                          <mat-card-title
                            >Taux d'Utilisation Globale</mat-card-title
                          >
                        </mat-card-header>
                        <mat-card-content>
                          <div class="chart-wrapper">
                            <canvas id="usageChart"></canvas>
                          </div>
                        </mat-card-content>
                      </mat-card>
                    </div>

                    <!-- Statistiques d'utilisation détaillées -->
                    <div class="usage-stats" *ngIf="kpiAppUsageData">
                      <div class="stats-grid">
                        <mat-card class="stat-card">
                          <mat-card-content>
                            <div class="stat-header">
                              <mat-icon>trending_up</mat-icon>
                              <h3>Fonctionnalités Populaires</h3>
                            </div>
                            <div class="feature-list">
                              <div
                                *ngFor="
                                  let feature of kpiAppUsageData.mostUsedFeatures
                                "
                                class="feature-item"
                              >
                                <div class="feature-name">
                                  {{ feature.feature }}
                                </div>
                                <div class="feature-stats">
                                  <mat-progress-bar
                                    mode="determinate"
                                    [value]="feature.percentage"
                                  >
                                  </mat-progress-bar>
                                  <span class="feature-percentage"
                                    >{{ feature.percentage }}%</span
                                  >
                                </div>
                              </div>
                            </div>
                          </mat-card-content>
                        </mat-card>

                        <mat-card class="stat-card">
                          <mat-card-content>
                            <div class="stat-header">
                              <mat-icon>login</mat-icon>
                              <h3>Statistiques de Connexion</h3>
                            </div>
                            <div class="login-stats">
                              <div class="login-stat">
                                <div class="login-value">
                                  {{ kpiAppUsageData?.loginStats.today }}
                                </div>
                                <div class="login-label">
                                  Connexions Aujourd'hui
                                </div>
                              </div>
                              <div class="login-stat">
                                <div class="login-value">
                                  {{ kpiAppUsageData?.loginStats.thisWeek }}
                                </div>
                                <div class="login-label">Cette Semaine</div>
                              </div>
                              <div class="login-stat">
                                <div class="login-value">
                                  {{ kpiAppUsageData?.loginStats.thisMonth }}
                                </div>
                                <div class="login-label">Ce Mois</div>
                              </div>
                            </div>
                          </mat-card-content>
                        </mat-card>
                      </div>
                    </div>
                  </div>
                </mat-tab>

                <!-- Onglet 3: Finalisation des Rapports -->
                <mat-tab [label]="'KPI.REPORT_COMPLETION' | translate">
                  <div class="tab-content">
                    <!-- Graphiques des rapports -->
                    <div class="charts-grid">
                      <mat-card class="chart-card">
                        <mat-card-header>
                          <mat-card-title
                            >Finalisation des Rapports par
                            Merchandiser</mat-card-title
                          >
                        </mat-card-header>
                        <mat-card-content>
                          <div class="chart-wrapper">
                            <canvas id="reportChart"></canvas>
                          </div>
                        </mat-card-content>
                      </mat-card>

                      <mat-card class="chart-card">
                        <mat-card-header>
                          <mat-card-title
                            >Évolution du Taux de Completion</mat-card-title
                          >
                        </mat-card-header>
                        <mat-card-content>
                          <div class="chart-wrapper">
                            <canvas id="trendChart"></canvas>
                          </div>
                        </mat-card-content>
                      </mat-card>
                    </div>

                    <!-- Table des rapports -->
                    <div class="table-container">
                      <mat-card>
                        <mat-card-header>
                          <mat-card-title>Détail des Rapports</mat-card-title>
                        </mat-card-header>
                        <mat-card-content>
                          <div class="table-wrapper">
                            <table
                              mat-table
                              [dataSource]="reportDataSource"
                              class="kpi-table"
                            >
                              <!-- Colonne Merchandiser -->
                              <ng-container matColumnDef="merchandiserName">
                                <th mat-header-cell *matHeaderCellDef>
                                  Merchandiser
                                </th>
                                <td mat-cell *matCellDef="let element">
                                  <div class="merchandiser-info">
                                    <strong>{{
                                      element.merchandiserName
                                    }}</strong>
                                    <span class="merchandiser-id"
                                      >#{{ element.merchandiserId }}</span
                                    >
                                  </div>
                                </td>
                              </ng-container>

                              <!-- Colonne Région -->
                              <ng-container matColumnDef="region">
                                <th mat-header-cell *matHeaderCellDef>
                                  Région
                                </th>
                                <td mat-cell *matCellDef="let element">
                                  <mat-chip-set>
                                    <mat-chip>{{ element.region }}</mat-chip>
                                  </mat-chip-set>
                                </td>
                              </ng-container>

                              <!-- Colonne Total Rapports -->
                              <ng-container matColumnDef="totalReports">
                                <th mat-header-cell *matHeaderCellDef>
                                  Total Rapports
                                </th>
                                <td mat-cell *matCellDef="let element">
                                  <div class="report-stats">
                                    <div class="total-reports">
                                      {{ element.totalReports }}
                                    </div>
                                    <div class="report-breakdown">
                                      <span class="completed"
                                        >{{
                                          element.reportsByStatus.completed
                                        }}
                                        complétés</span
                                      >
                                      <span class="in-progress"
                                        >{{
                                          element.reportsByStatus.inProgress
                                        }}
                                        en cours</span
                                      >
                                      <span class="pending"
                                        >{{
                                          element.reportsByStatus.pending
                                        }}
                                        en attente</span
                                      >
                                      <span
                                        class="overdue"
                                        *ngIf="
                                          element.reportsByStatus.overdue > 0
                                        "
                                        >{{
                                          element.reportsByStatus.overdue
                                        }}
                                        en retard</span
                                      >
                                    </div>
                                  </div>
                                </td>
                              </ng-container>

                              <!-- Colonne Taux de Completion -->
                              <ng-container matColumnDef="completionRate">
                                <th mat-header-cell *matHeaderCellDef>
                                  Taux de Completion
                                </th>
                                <td mat-cell *matCellDef="let element">
                                  <div class="completion-info">
                                    <div class="completion-rate">
                                      {{ element.completionRate }}%
                                    </div>
                                    <mat-progress-bar
                                      mode="determinate"
                                      [value]="element.completionRate"
                                      [color]="
                                        getCompletionRate(
                                          element.completionRate
                                        )
                                      "
                                    >
                                    </mat-progress-bar>
                                  </div>
                                </td>
                              </ng-container>

                              <!-- Colonne Statut -->
                              <ng-container matColumnDef="status">
                                <th mat-header-cell *matHeaderCellDef>
                                  Statut
                                </th>
                                <td mat-cell *matCellDef="let element">
                                  <mat-chip-set>
                                    <mat-chip
                                      [style.background-color]="
                                        getCompletionColor(
                                          element.completionRate
                                        )
                                      "
                                    >
                                      {{
                                        getCompletionStatus(
                                          element.completionRate
                                        )
                                      }}
                                    </mat-chip>
                                  </mat-chip-set>
                                </td>
                              </ng-container>

                              <!-- Colonne Temps Moyen -->
                              <ng-container matColumnDef="averageTime">
                                <th mat-header-cell *matHeaderCellDef>
                                  Temps Moyen
                                </th>
                                <td mat-cell *matCellDef="let element">
                                  <div class="average-time">
                                    <mat-icon>schedule</mat-icon>
                                    {{ element.averageReportTime }}
                                  </div>
                                </td>
                              </ng-container>

                              <tr
                                mat-header-row
                                *matHeaderRowDef="reportColumns"
                              ></tr>
                              <tr
                                mat-row
                                *matRowDef="let row; columns: reportColumns"
                              ></tr>
                            </table>

                            <mat-paginator
                              #reportPaginator
                              [pageSizeOptions]="[5, 10, 20]"
                              [pageSize]="10"
                              showFirstLastButtons
                            >
                            </mat-paginator>
                          </div>
                        </mat-card-content>
                      </mat-card>
                    </div>
                  </div>
                </mat-tab>
              </mat-tab-group>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
